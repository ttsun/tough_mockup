{% extends "base.html" %}

{% block head %}
 <link rel="stylesheet" type="text/css" href="/static/css/jquery-ui-1.10.3.custom.min.css">
<script type="text/javascript" src="/static/js/jquery-ui-1.10.3.custom.min.js"></script>
<style type="text/css"> 

textarea{
    width:auto;
}
#dirinput, #compSettingsForm{
    padding:2em;
}

#id_max_walltime_0, #id_max_walltime_1{
    width: 65px;
}
[name='rawinput']{
    width:98%;
}
ul{
    list-style-type: none;
}
li{
    word-wrap: break-word;
}
</style>
<script type="text/javascript">

var current_doc;
var newjob;
var homedir;
var scratchdir;
var jobfiles;
var job_id;

function setupBlocks(blockName){
    var block = $("#reqblocks").append("<li></li>");
    $("#reqblocks").children("li").last().attr("id", blockName);
    $("#reqblocks").children("li").last().attr("class", "blockchoice");
    $("#reqblocks").children("li").last().html("<a href=\"#\"" + blockName + ">" + blockName + "</a>");
}

function showRawInput(blockName){

}

function getjobfiles(){

    $.ajax({
        type:'GET',
        url: TOUGH_SUBDIR + '/get_tough_files/' + job_id,

        success: function(data){
            jobfiles = data;
        },
        error: function(err){
            alert("There was a problem getting the input files.");
            $('#fileloader').hide();
        },
    });
}

$(document).ready(function(){
        {% if new_job %}
            Alertify.log.success("{{job_name}}"+" created at "+"{{job.jobdir}}");
        {% endif %}
    $("#compset").removeClass("inputarea").addClass("inputareaactive");
    current_doc = "batch";
    $(".inputarea:not(.inputareaactive)").hide();
    // Listens for forms to be submitted
    // Makes ajax calls when forms are submitted
    // Makes an exception for dirinput because dirinput needs to change pages
   $("form").submit(function(e){
        e.preventDefault();
        Alertify.log.info("Saving " + current_doc + " block");
        var href = $(this).parent().parent().parent(".inputarea").attr("id");
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if(data.success){
                Alertify.log.success("Block successfully saved!");
                if($("[href='#"+href+"']").children('i').length == 0){
                    $("[href='#"+href+"']").append("<i class='icon-ok'></i>");
                }
            }else{
                Alertify.log.error(data.error);
            }
        });
        return false;
   });   


   $("#sidebar a:not(#submit_job, #upload_MESH, #upload_input)").click(function(e){
        if($(this).parent("li[class~=disabled]").length == 0){
            e.preventDefault();
            $("#sidebar .active").removeClass("active");
            $(this).parent("li").addClass("active");
            showInputArea($(this).attr("href"));
        }
    });
   $("#uploadformbox").dialog({
        autoOpen: false,
        width:400,
        position: {my:"top", at:"top", of:$(".container")},
    });
    $(".popup").click(function(e){
        e.preventDefault();
        $("#uploadformbox").load($(this).attr("href"), function(){
            $("#uploadformbox").dialog("open");                    
        });
        return false;
    });
});
   // $("#upload_MESH").click(function(e){
   //      e.preventDefault();
   //      showInputArea($(this).attr("href"));
   // });

   function showInputArea(id){
        $(".inputareaactive").removeClass("inputareaactive").hide();
        current_doc = $(id).attr("id");
        $(id).addClass("inputareaactive").show();
        console.log($(id));
        $(".inputarea:not(.inputareaactive)").hide();
    }


</script>
{% endblock head %}

{%block content %}
<div class = "row-fluid">
    <div class = "span2 well" id = "sidebar">
        {% if job_id %}
        <ul id="jobdetails" class = "nav nav-list">
            <li class = "nav-header">Job Details</li>
                <li><b>Machine:</b> {{job.machine|capfirst}}</li>
                <li><b>Project:</b> {{job.project.name|capfirst}}</li>
                <li><b>Job Name:</b> {{job_name|capfirst}}</li>
        </ul>
        {% endif %}
        <ul class = "nav nav-list">
            <li class = "nav-header">Required Information</li>
            <li id = "batchselect" class = "blockchoice active"><a href="#compset" id = "batch" >Computational Settings</a></a>
        </ul>
        <ul id = "reqblocks" class = "nav nav-list">
            <li class = "nav-header">Required Blocks</li>
            {% for block in job.get_req_blocks %}
                <li class="blockchoice"><a href="#{{block.blockType.tough_name}}">{{block.blockType.name|capfirst}}
                    {% if not block.is_empty %} <i class="icon-ok"></i>{% endif %}</a></li>
            {% endfor %}
        </ul>
        <ul id = "opblocks" class="nav nav-list">
            <li class = "nav-header"> Optional Blocks</li>
            {% for block in job.get_op_blocks %}
                <li class="blockchoice"><a href="#{{block.blockType.tough_name}}">{{block.blockType.name|capfirst}}
                    {% if not block.is_empty %}<i class="icon-ok"></i>{% endif %}</a></li>
            {% endfor %}
        </ul>
        {% if job_id %}
            <a href = "{% url 'tough.views.file_upload_view' job_id=job_id file_type='mesh' %}" id = "upload_MESH" class = "popup btn btn-small btn-primary span10" style = "margin:10px">Upload a MESH File</a>
            <p><b>Last MESH upload:</b> {{mesh.last_uploaded}}</p>
            <a href = "{% url 'tough.views.file_upload_view' job_id=job_id file_type='infile' %}" id = "upload_input" class = "popup btn btn-small btn-primary span10" style = "margin-bottom:10px; margin-left:10px">Upload an Input File</a>
            <a href = "{% url 'tough.views.ajax_submit' job_id=job_id %}" id="submit_job" class = "btn btn-success btn-large span11">SUBMIT</a>
        {% endif %}
    </div>
    {% if job_id %}
    <div class = "span10 inputarea" id = "compset">
        <h2>Computational Settings</h2>
        {% include "batch_form.html" %}
    </div>
    
    {% for block in job.get_req_blocks%}
        {% include "block_input.html" %}
    {% endfor %}
    {% for block in job.get_op_blocks%}
        {% include "block_input.html" %}
    {% endfor %}
    {% endif %}

</div>
<div id = "uploadformbox">
</div>
{% endblock content %}    