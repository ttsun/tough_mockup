
{% extends "base.html" %}

{% block head %}
<script type="text/javascript" src="/static/js/alertify.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/alertify.css"/>
<link rel="stylesheet" type="text/css" href="/static/css/alertify.bootstrap.css"/>
<style type="text/css"> 

textarea{
    width:auto;
}
#dirinput, #batch_form{
    padding:2em;
}

#id_max_walltime_0, #id_max_walltime_1{
    width: 65px;
}
#id_rawinput{
    rows:30;
    cols:80;
}
ul{
    list-style-type: none;
}
</style>

<script type="text/javascript" src="/static/js/blocks.js"></script>
<script type="text/javascript" src="/static/js/setup.js"></script>
<script type="text/javascript">

var jobfiles;
var current_doc;
var jobid;
var newjob;
var homedir;
var scratchdir;

function getjobfiles(){
    $('#fileloader').show();
    $.ajax({
        type: 'GET',

        url: TOUGH_SUBDIR+'/get_tough_files/' + jobid,

        success: function(data){
            jobfiles = data;
            $('#fileloader').hide();
            console.log(jobfiles);
        },
        error: function(err){
            // alert("There was a problem getting the input files.");
            $('#fileloader').hide();
        }
    });
}

function setupBlocks(blockName){
    var block = $("#reqblocks").append("<li></li>");
    $("#reqblocks").children("li").last().attr("id", blockName);
    $("#reqblocks").children("li").last().attr("class", "blockchoice");
    $("#reqblocks").children("li").last().html("<a href=\"#\"" + blockName + ">" + blockName + "</a>");
}

function showRawInput(blockName){

}

$(document).ready(function(){
    homedir = "/global/homes/" + "{{username}}".charAt('0') + "/" + "{{username}}";
    scratchdir = "/global/scratch/sd/" + "{{username}}";
    if($("#dirset").attr("class")=="active"){
        $("#dirsetup").removeClass("inputarea").addClass("inputareaactive");
        $(".blockchoice").addClass("disabled");
    } else {
        $("#compset").removeClass("inputarea").addClass("inputareaactive");
        Alertify.log.success("{{job_name}}"+" created at "+"{{job_jobdir}}");
        current_doc = "batch";
        jobid = {{job_id|default:None}};
        getjobfiles();
    }
    $(".inputarea:not(.inputareaactive)").hide();
   $(".diroptions").click(function(e){
       e.preventDefault();
       if($(this).attr("id") == "homedir"){
        $("#jobdir").val(homedir);
       } else {
        $("#jobdir").val(scratchdir);
       }
   });
   $("#batch").click(function(e){
        guify_batch();
   });
   $('#savecompset').click(function(e){
        console.log("saved comp set")
        save_batch();
   });
   $("#submitdir").click(function(ev){
        current_doc = "batch";
        ev.preventDefault();
        // document.forms['dirinput'].submit();
        $.ajax({
            url: $("#dirinput").attr("action"),
            data: $("#dirinput").serialize(),
            type: "POST",
            success: function(data){
                window.location.href = data['job_url'];
            }
        });
        var values = {};
        $.each($('#dirinput').serializeArray(), function(i, field) {
            values[field.name] = field.value;
        });
        Alertify.log.info("Creating job directory for \"" + values["jobname"] + "\" in \"" + values["jobdir"] + "\"");
        
   });
   $("#saverawblock").click(function(e){
        Alertify.log.info("Saving " + current_doc + " block");
        save_form();
   })
   $("#sidebar a").click(function(e){
        if($(this).parent().attr("id") == "batchselect" && $(this).parent("li[class~=disabled]").length == 0){
            guify_batch();
        }
        current_doc = $(this).attr("id")
        if($(this).parent("li[class~=disabled]").length == 0){
            e.preventDefault();
            showInputArea($(this).attr("id"));
            current_doc = $(this).attr("id");
        }
        return false;
    });
   
});


function showInputArea(id){
    $(".inputareaactive").removeClass("inputareaactive").hide();
    $("#sidebar .active").removeClass("active");
    if ($("#"+id).parent("li").attr("class") != "disabled"){
        $("#"+id).parent("li").addClass("active");
    }
    $($("#"+id).attr("href")).addClass("inputareaactive").show();
    console.log($("#"+id).attr("href"));
    $(".inputarea:not(.inputareaactive)").hide();
}
</script>
{% endblock head %}

{%block content %}
<div class = "row-fluid">
    <div class = "span2 well" id = "sidebar">
        <ul class = "nav nav-list">
            <li class = "nav-header">Required Information</li>
            {% if job_id %}
            <li id = "dirset" class = "disabled"><a href="#dirsetup">Directory Setup</a></li>
            <li id = "batchselect" class = "blockchoice active"><a href="#blockinput" id = "batch" >Computational Settings</a></a>
            {% else %}
            <li class = "active" id = "dirset"><a href="#dirsetup">Directory Setup</a></li>
            <li class = "blockchoice disabled" id = "batchselect"><a href="#compset" id = "batch">Computational Settings</a></li>
            {% endif %}
        </ul>
        <ul id = "reqblocks" class = "nav nav-list">
            <li class = "nav-header">Required Blocks</li>
            <li class = "blockchoice"><a href="#blockinput" id = "ROCKS">ROCKS</a></li>
            <li class = "blockchoice"><a href="#blockinput" id = "Block2">Block 2</a></li> 
            <li class = "blockchoice"><a href="#blockinput" id = "Block3">Block 3</a></li> 
            <li class = "blockchoice"><a href="#">Block 4</a></li>
            <li class = "blockchoice"><a href="#">Block 5</a></li>
        </ul>
        <ul id = "opblocks" class="nav nav-list">
            <li class = "nav-header"> Optional Blocks</li>
            <li class = "blockchoice"><a href="#">Block 1</a></li>
            <li class = "blockchoice"><a href="#">Block 2</a></li> 
            <li class = "blockchoice"><a href="#">Block 3</a></li> 
            <li class = "blockchoice"><a href="#">Block 4</a></li>
            <li class = "blockchoice"><a href="#">Block 5</a></li>
        </ul>
    </div>
    <div class = "span10 inputarea" id = "dirsetup">
        <h2>Directory Setup</h2>
         <form action="{% url 'tough.views.create_job' %}" method = "POST" id="dirinput">
            {% csrf_token %}
            <input type = "hidden" name ="setup_type" id = "setup_type" value = "new" />
            <div>
            <label for="jobname">What do you want to name this job?</label>
            <input type="text" name="jobname" id="jobname" size="50"/>
            </div>
            <div>
                <label for="machine">Which machine should this job run on?</label>
                <select name="machine" id="machine">
                    <option value="hopper" selected="selected">hopper</option>
                    <option value="carver">carver</option>
                </select>
            </div>
            <div class="input-append">
                <label for"jobdir">Where would you like to store this job?</label>
                <input type="text" name="jobdir" id="jobdir" size="50" value="/global/">
                <div class="btn-group">
                    <button class="btn dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" id="dirSelect">
                        <li><a class='diroptions' href="#" id = "homedir" >Home Directory</a></li>
                        <li><a class='diroptions' href="#" id = "scratchdir">Scratch Directory</a><li>
                    </ul>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" type="button" id='submitdir'>Submit</button>
            </div>
        </form>
    </div>
    <div class = "span10 inputarea" id = "compset">
        <h2>Computational Settings</h2>
        {% include "batch_form.html" %}
    </div>
    <div class = "span10 inputarea" id = "blockinput">
        <ul class = "nav nav-tabs">
            <li class = "active"><a href="#guided" data-toggle = "tab">Guided</a></li>
            <li><a href="#raw" data-toggle = "tab">Raw Text</a></li>
        </ul>
        <div class = "tab-content" style =" height:500px">
            <div class = "tab-pane active" id = "guided" style = "height:500px">
                <p>
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas nisi ligula, varius sit amet convallis eget, ullamcorper vitae lorem. Ut ultricies erat turpis, quis eleifend ante ultrices id. Donec ut est venenatis, viverra enim nec, placerat quam. Duis hendrerit fringilla dolor id fringilla. Nulla facilisi. Proin aliquet nisi ultricies, luctus lacus in, sodales felis. Aenean quis ullamcorper est, ac gravida nunc. Phasellus nunc diam, vehicula quis tortor et, facilisis pellentesque dui. Praesent eleifend lorem nec odio pulvinar commodo. Integer at condimentum justo, ac placerat libero.
                </p>
            </div>
            <div class = "tab-pane" id = "raw">
                <form id="rawtextform" action="" method="POST">
                    {% csrf_token %}
                    {%for field in job.get_raw_input_form%}
                    <div class = "control-group">
                        <div class = "control">
                        {{ field }}
                        </div>
                    </div>
                    {% endfor %}
                <button class="btn" type="button" id='saverawblock'>Save</button>
                <button class="btn" type="button" id='cancel'>Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}    