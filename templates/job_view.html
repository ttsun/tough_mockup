{% extends "base.html"%}
{% load file_filters %}
{% block head %}
	<script type="text/javascript">
		$(document).ready(function(){
			getFolder("");
			$("#deljob").click(function(e){
                e.preventDefault();
                var url = $(this).attr("href");
                Alertify.dialog.confirm("Are you sure you want to delete this job? This operation is irreversable", 
                    function(){
                        Alertify.dialog.confirm("Do you want to delete the associated job files?", 
                            function(){
                                console.log(url);
                                $.post(url, {"files": true}, function(data){
                                    window.location.href=data.redirect;
                                    return false;
                                });
                            }, 
                            function(){
                                $.post(url, function(data){
                                    window.location.href=data.redirect;
                                    return false;
                                });
                            }
                        );
                    }, 
                    function(){
                        return false;
                    }
                );
            });			
		});

		function getFolder(dir){
			$("#file_list").html("");
			$(".loader").show();
			$.get("{% url 'tough.views.ajax_get_job_dir' job_id=job.pk %}" + dir, function(response){
				$(".loader").hide();
				if(response.success){
					for(var x in response.listing){
						var file = response.listing[x];
						$("#file_list").append("<tr class='entry'></tr>");
						var curr_entry = $($(".entry").last());
						if(file.is_folder){
							if(file.name==".."){
								curr_entry.append("<td><a class='folder' href='/job/{{job.pk}}/file/"+dir+file.name+"/' data-dir='"+dir+file.name+"/'><i class='icon-folder-close'></i>"+file.name+"</a></td>");
							}else{								
								curr_entry.append("<td><a class='folder' href='/job/{{job.pk}}/file/"+dir+file.name+"/' data-dir='"+dir+file.name+"/'><i class='icon-folder-close'></i>"+file.name+"</a></td>");
							}
						}else{
							curr_entry.append("<td><a class = 'view file' target='_blank' href = '/job/{{job.pk}}/view/"+dir+file.name+"/'><i class='icon-file'></i>"+file.name+"</a></td>");
						}
						curr_entry.append("<td>"+file.size+"</td>");
						curr_entry.append("<td>"+file.date+"</td>");
						if(file.is_folder == false){
							curr_entry.append("<td><a class='file' href='/job/{{job.pk}}/file/"+dir+file.name+"/'><i class='icon-download-alt'></i>Download File</a></td>");
						}else{
							if(file.name != ".."){
								curr_entry.append("<td><a href='/job/{{job.pk}}/zip/"+dir+file.name+"'><i class='icon-download-alt'></i>Download ZIP</a></td>");
							}
						}
					}
					$(".folder").click(function(e){
						e.preventDefault();
						getFolder($(this).attr("data-dir"));
						return false;
					});
					$(".view").click(function(e){
						e.preventDefault();
						window.open($(this).attr("href"), "", 'width=800,height=500,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1');
						return false;
					});
				}
			});
		}
	</script>
{% endblock head %}
{% block content %}
<div class = "row-fluid">
	<div class = "span2 well">
		<ul class = "nav nav-list">
			<li class="nav-header">Options</li>
		   	<li><a href = "{% url 'tough.views.create_job' 'copy' job.pk%}" id = "copyjob" class = "popup">Copy Job</a></li>
			<li><a href = "{% url 'tough.views.delete_job' job.pk %}" id = "deljob">Delete Job</a></li>
			<li><a href = "{%url 'tough.views.ajax_get_zip' job_id=job.pk %}">Download {{job.jobname}} as ZIP</a></li>
		</ul>
	</div>
	<div class = "span10">
		<h1>{{jobname}}</h1>
		<h2>Job Information</h2>
		<div class="row-fluid">
			<div class="span6">			
				<p><strong>System:</strong> Hopper</p>
				<p><strong>Job Directory:</strong> {{jobdir}}</p>
				<p><strong>Number of Processors:</strong> {{job.numprocs}}</p>		
				<p><strong>Job Status:</strong> {{job.state | capfirst}}</p>
			</div>
			<div class="span6">				
				{% if job.time_submitted %}
					<p><strong>Time Submitted:</strong> {{job.time_submitted}}</p>
				{% endif %}
				{% if job.time_started %}
					<p><strong>Time Started:</strong> {{job.time_started}}</p>
				{% endif %}
				{% if job.time_completed %}
					<p><strong>Time Completed:</strong> {{job.time_completed}}</p>
				{% endif %}
				{% if job.project %}
					<p><strong>Project:</strong> {{job.project.name}}</p>
				{% endif %}
				{% if job.timeuse %}
					<p><strong>Time Elapsed:</strong> {{job.timeuse}}</p>
				{% endif %}
			</div>
		</div>
		<div class="row-fluid">
			<h2>Files <img class='loader' src='/static/img/ajax-loader.gif'/></h2>				
			<table class = "table table-hover table-striped">
				<thead>
					<tr>
						<th>File Name</th>
						<th>Size</th>
						<th>Last Modified</th>
						<th>Options</th>
					</tr>
				</thead>
				<tbody id="file_list">
				</tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}
